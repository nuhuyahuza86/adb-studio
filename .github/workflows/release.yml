name: üöÄ Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: üì¶ Build & Release
    runs-on: macos-26

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v6

      - name: üõ†Ô∏è Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer

      - name: üìã Show Xcode version
        run: xcodebuild -version

      - name: üè∑Ô∏è Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: üèóÔ∏è Build Release
        run: |
          xcodebuild -scheme "ADB-Studio" \
            -configuration Release \
            -destination "platform=macOS,arch=arm64" \
            -derivedDataPath build \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION="${{ steps.version.outputs.VERSION }}" \
            CURRENT_PROJECT_VERSION="${{ github.run_number }}"

      - name: üîè Ad-hoc Sign
        run: |
          codesign --force --deep --sign - "build/Build/Products/Release/ADB-Studio.app"

      - name: üíø Create DMG
        run: |
          APP_NAME="ADB-Studio"
          DMG_DIR="dmg-contents"
          FINAL_DMG="ADB-Studio-${{ steps.version.outputs.VERSION }}.dmg"

          mkdir -p "${DMG_DIR}"
          cp -R "build/Build/Products/Release/${APP_NAME}.app" "${DMG_DIR}/"
          ln -s /Applications "${DMG_DIR}/Applications"

          hdiutil create -srcfolder "${DMG_DIR}" \
            -volname "${APP_NAME}" \
            -fs HFS+ \
            -format UDZO \
            -imagekey zlib-level=9 \
            "${FINAL_DMG}"

          echo "DMG_PATH=${FINAL_DMG}" >> $GITHUB_ENV

      - name: üóúÔ∏è Create ZIP
        run: |
          cd build/Build/Products/Release
          zip -r -y "../../../../ADB-Studio-${{ steps.version.outputs.VERSION }}.zip" "ADB-Studio.app"
          cd ../../../..
          echo "ZIP_PATH=ADB-Studio-${{ steps.version.outputs.VERSION }}.zip" >> $GITHUB_ENV

      - name: üîê Generate Checksums
        run: |
          shasum -a 256 "${{ env.DMG_PATH }}" > checksums.txt
          shasum -a 256 "${{ env.ZIP_PATH }}" >> checksums.txt
          cat checksums.txt

      - name: üî¢ Extract ZIP SHA256
        id: sha
        run: |
          SHA256=$(shasum -a 256 "${{ env.ZIP_PATH }}" | awk '{print $1}')
          echo "ZIP_SHA256=${SHA256}" >> $GITHUB_OUTPUT

      - name: üéâ Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ADB-Studio v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            ${{ env.DMG_PATH }}
            ${{ env.ZIP_PATH }}
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üç∫ Update Homebrew Tap
        if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc') }}
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          ZIP_SHA256: ${{ steps.sha.outputs.ZIP_SHA256 }}
        run: |
          git config --global url."https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          git clone https://github.com/Zaphkiel-Ivanovna/homebrew-tap.git
          cd homebrew-tap

          cat > Casks/adb-studio.rb << CASK
          cask "adb-studio" do
            version "${VERSION}"
            sha256 "${ZIP_SHA256}"

            url "https://github.com/Zaphkiel-Ivanovna/adb-studio/releases/download/v#{version}/ADB-Studio-#{version}.zip",
                verified: "github.com/Zaphkiel-Ivanovna/adb-studio/"
            name "ADB Studio"
            desc "Manage Android devices via ADB"
            homepage "https://github.com/Zaphkiel-Ivanovna/adb-studio"

            livecheck do
              url :url
              strategy :github_latest
            end

            depends_on macos: ">= :sonoma"

            app "ADB-Studio.app"

            zap trash: [
              "~/Library/Application Support/ADB-Studio",
              "~/Library/Caches/dev.zaphkiel.adbstudio",
              "~/Library/Preferences/dev.zaphkiel.adbstudio.plist",
              "~/Library/Saved Application State/dev.zaphkiel.adbstudio.savedState",
            ]
          end
          CASK

          # Remove leading whitespace from heredoc
          sed -i '' 's/^          //' Casks/adb-studio.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/adb-studio.rb
          git commit -m "‚¨ÜÔ∏è Update ADB Studio to v${VERSION}"
          git push
